name: flightDurationInMunicipalityLowAltitudeInPeriod
source: "municipalities g"
source_data:
  type: csv
  path: "municipalities-wkt.csv"
  geometry_column: polygon
  csv_options:
    delimiter: ";"
    header: true
    infer_schema: false
  schema:
    - { name: name }
    - { name: polygon }

select:
  - "g.name"
  - "f.flightid"

aggregations:
  - function: MIN
    field: "f.timestamp"
    alias: entry_time
  - function: MAX
    field: "f.timestamp"
    alias: exit_time
  - function: COUNT
    field: "*"
    alias: point_count   # chaque point = 1 seconde sous ton mod√®le

joins:
  - type: inner
    source: "flight_points f"
    source_data:
      type: csv
      path: "point_NRW_HIGH_0123.csv"
      geometry_column: wkt
      csv_options:
        delimiter: ";"
        header: false
        infer_schema: false
      schema:
        - { name: flightid }
        - { name: airplanetype }
        - { name: origin }
        - { name: destination }
        - { name: wkt }
        - { name: timestamp }
        - { name: altitude, type: double }
    clause:
      spatial_filter:
        - type: intersects
          args: ["f.geom", "g.geom"]

filter:
  - field: g.name
    operator: eq
    value: "'Gem Brilon'"
  - time_filter:
      - field: f.timestamp
        start: "'2023-01-02 17:49:01'"
        end: "'2023-01-02 17:49:13'"
  - field: f.altitude
    operator: lt
    value: 4000

group_by:
  - "g.name"
  - "f.flightid"